# Lyceum Bot — Внедрение проекта

## Введение

Lyceum Bot — Телеграм-бот, позволяющий быстро и в удобном формате просматривать расписание пар Лицея №2 г. Перми.
Ранее с этим была проблема: приходилось заходить на сайт лицея, искать ссылку на актуальное расписание и переходить в
Яндекс Диск, у которого есть лимиты на просмотры файлов (без скачивания) в день.  
Сейчас все эти действия заменяются несколькими кликами в интерфейсе бота: необходимо лишь выбрать день с помощью удобных
inline-кнопок.

Одним из главных требований к боту была актуальность данных — программа должна была уметь фиксировать изменения в
расписании и отправлять пользователю актуальную информацию. Этого удалось добиться с помощью регулярного автоматического
обновления таблицы с расписанием.

## Условия внедрения

Для внедрения был использован сервер на Linux Ubuntu 18.04 в следующей конфигурации:

* 1 CPU
* 1 Gb RAM
* 15 Gb SSD

## Ссылки на свободные решенения

Открытые решения, использованные при разработке:

* [aiogram](https://pypi.org/project/aiogram/)
* [openpyxl](https://pypi.org/project/openpyxl/)
* [wget](https://pypi.org/project/wget/)

Открытые решения, использованные при внедрении:

* [PM2 Process Manager](https://github.com/Unitech/pm2)

## Ход внедрения

В этом разделе описан процесс внедрения и настройки Телеграм-бота на сервере.

1. Чтобы бот работал, серверу потребуется модуль языка Python:
   ```
   sudo apt —reinstall install python3 -y
   sudo apt —reinstall install python3-pip -y
   ```

2. Теперь нам нужно установить удобный менеджер процессов PM2 и платформу Node.js с менеджером пакетов npm
   для её работы:
   ```
   sudo apt install nodejs
   sudo apt install npm
   npm install pm2 -g
   ```

3. Переносим файлы программы на сервер, переходим к директории `lyceumbot`, устанавливаем зависимости:
   ```
   cd lyceumbot
   pip3 install -r requirements.txt
   ```

4. Переходим к директории `App`, с помощью PM2 запускаем основной скрипт бота и скрипт автоматического обновления
   данных:
   ```
   cd App
   pm2 start main.py --interpreter=python3
   pm2 start updater.py --interpreter=python3
   ```

5. Для мониторинга работы вводим команду:
   ```
   pm2 list
   ```

## Результат внедрения

Средняя нагрузка на процессор — 10%. Во время обновления данных нагрузка на CPU достигает 25-30%. Это значит, что у нас
ещё есть много ресурсов для расширения функционала бота

![Нагрузка на процессор](https://i.ibb.co/SwJcTT1/CPU.png)

Благодаря разработанному и успешно внедрённому решению ученики, родители и преподаватели могут узнавать актуальную
информацию о расписании пар и звонков без траты лишнего времени. Активными пользователями бота являются более 600
человек.

## Комментарии и помощь по эксплуатации

При появлении проблем при установке PM2 попробуйте установить более новую версию Node.js (минимум 10.0), удобнее всего
это будет сделать при помощи утилиты nvm. Подробнее можно прочитать в
статье: https://www.digitalocean.com/community/tutorials/node-js-ubuntu-18-04-ru (пункт Установка при помощи NVM).

Если модуль парсера таблицы (`parser.py`) внезапно перестал работать, возможно, изменился формат google-таблицы с
распианием. В таком случае рекомендуется установить код с [GitHub проекта](https://github.com/skosarevv/lyceumbot), в
котором будут находиться исправления, решающие проблему.

Если бот не работает, убедитесь, что токен бота указан в файле `configuration.py`.